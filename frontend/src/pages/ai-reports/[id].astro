---
import Layout from '../../layouts/Layout.astro'
import { supabase } from '../../lib/supabase'

const { id } = Astro.params

if (!id) {
  return Astro.redirect('/404')
}

// Fetch AI report data
let report = null
let breach = null
let error = null

try {
  // Get AI report
  const { data: aiData, error: aiError } = await supabase
    .from('breach_ai')
    .select('*')
    .eq('breach_id', id)
    .single()

  if (aiError) {
    throw new Error(`AI report not found: ${aiError.message}`)
  }

  report = aiData

  // Get breach data
  const { data: breachData, error: breachError } = await supabase
    .from('breach_raw')
    .select('*')
    .eq('id', id)
    .single()

  if (breachError) {
    throw new Error(`Breach not found: ${breachError.message}`)
  }

  breach = breachData

} catch (err) {
  error = err instanceof Error ? err.message : 'Unknown error'
  console.error('Error loading AI report:', err)
}

if (error || !report || !breach) {
  return Astro.redirect('/404')
}

// Format the report content for display
const formatReportContent = (content: string) => {
  return content
    // Convert markdown links to HTML
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">$1</a>')
    // Convert bold text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // Convert italic text
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // Convert headers
    .replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold mt-6 mb-3">$1</h3>')
    .replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold mt-8 mb-4">$1</h2>')
    .replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold mt-8 mb-4">$1</h1>')
    // Convert line breaks
    .replace(/\n/g, '<br>')
}

const formattedContent = formatReportContent(report.ai_report)
---

<Layout title={`AI Report - ${breach.organization_name}`}>
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">
              {breach.organization_name} - AI Breach Analysis
            </h1>
            <div class="flex items-center space-x-4 mt-2">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                ü§ñ AI Generated
              </span>
              <span class="text-sm text-gray-500">
                Generated: {new Date(report.generated_at).toLocaleDateString()}
              </span>
              {report.model_used && (
                <span class="text-sm text-gray-500">
                  Model: {report.model_used}
                </span>
              )}
            </div>
          </div>
          <div class="flex space-x-2">
            <button 
              onclick="window.print()" 
              class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              üìÑ Print
            </button>
            <button 
              onclick="navigator.share ? navigator.share({title: document.title, url: window.location.href}) : navigator.clipboard.writeText(window.location.href)" 
              class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              üîó Share
            </button>
          </div>
        </div>
      </div>

      <!-- Breach Summary -->
      <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Breach Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">Organization</dt>
            <dd class="mt-1 text-sm text-gray-900">{breach.organization_name}</dd>
          </div>
          {breach.affected_people_count && (
            <div>
              <dt class="text-sm font-medium text-gray-500">People Affected</dt>
              <dd class="mt-1 text-sm text-gray-900">{breach.affected_people_count.toLocaleString()}</dd>
            </div>
          )}
          {breach.breach_date && (
            <div>
              <dt class="text-sm font-medium text-gray-500">Breach Date</dt>
              <dd class="mt-1 text-sm text-gray-900">{new Date(breach.breach_date).toLocaleDateString()}</dd>
            </div>
          )}
          {breach.source_name && (
            <div>
              <dt class="text-sm font-medium text-gray-500">Source</dt>
              <dd class="mt-1 text-sm text-gray-900">{breach.source_name}</dd>
            </div>
          )}
          {breach.data_types && (
            <div>
              <dt class="text-sm font-medium text-gray-500">Data Types</dt>
              <dd class="mt-1 text-sm text-gray-900">{breach.data_types}</dd>
            </div>
          )}
          {breach.notice_sent && (
            <div>
              <dt class="text-sm font-medium text-gray-500">Notice Sent</dt>
              <dd class="mt-1 text-sm text-gray-900">{breach.notice_sent ? 'Yes' : 'No'}</dd>
            </div>
          )}
        </div>
      </div>

      <!-- AI Report Content -->
      <div class="bg-white rounded-lg shadow-sm border p-6">
        <h2 class="text-lg font-semibold mb-6">AI Analysis Report</h2>
        <div class="prose prose-sm max-w-none">
          <div set:html={formattedContent} />
        </div>
      </div>

      <!-- Back Button -->
      <div class="mt-6 text-center">
        <button 
          onclick="window.history.back()" 
          class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          ‚Üê Back to Dashboard
        </button>
      </div>
    </div>
  </div>
</Layout>

<style>
  @media print {
    .no-print {
      display: none !important;
    }
  }
</style>
