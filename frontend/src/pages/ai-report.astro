---
import Layout from '../layouts/Layout.astro'
---

<Layout title="AI Breach Report - Security Intelligence Hub">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Loading State -->
    <div id="loading-state" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
          Loading AI Report
        </h2>
        <p class="text-gray-600 dark:text-gray-400">
          Retrieving your breach analysis...
        </p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="min-h-screen flex items-center justify-center hidden">
      <div class="text-center max-w-md">
        <div class="text-red-600 dark:text-red-400 mb-4">
          <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Report Not Found</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4" id="error-message">
          The requested report could not be found.
        </p>
        <button
          onclick="window.history.back()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
        >
          Go Back
        </button>
      </div>
    </div>

    <!-- Report Content -->
    <div id="report-content" class="hidden">
      <!-- This will be populated by JavaScript -->
    </div>
  </div>
  <style>
    .markdown-content {
      max-width: none;
      color: #374151;
    }

    .dark .markdown-content {
      color: #d1d5db;
    }

    .markdown-content h1 {
      font-size: 1.875rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 1rem;
    }

    .dark .markdown-content h1 {
      color: #ffffff;
      border-bottom-color: #374151;
    }

    .markdown-content h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .dark .markdown-content h2 {
      color: #ffffff;
    }

    .markdown-content h3 {
      font-size: 1.25rem;
      font-weight: 500;
      color: #111827;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .dark .markdown-content h3 {
      color: #ffffff;
    }

    .markdown-content p {
      color: #374151;
      margin-bottom: 1rem;
      line-height: 1.625;
    }

    .dark .markdown-content p {
      color: #d1d5db;
    }

    .markdown-content ul, .markdown-content ol {
      color: #374151;
      margin-bottom: 1rem;
      margin-left: 1.5rem;
    }

    .dark .markdown-content ul, .dark .markdown-content ol {
      color: #d1d5db;
    }

    .markdown-content li {
      margin-bottom: 0.5rem;
    }

    .markdown-content a {
      color: #2563eb;
      text-decoration: underline;
    }

    .markdown-content a:hover {
      color: #1d4ed8;
    }

    .dark .markdown-content a {
      color: #60a5fa;
    }

    .dark .markdown-content a:hover {
      color: #93c5fd;
    }

    .markdown-content strong {
      font-weight: 600;
      color: #111827;
    }

    .dark .markdown-content strong {
      color: #ffffff;
    }

    .markdown-content em {
      font-style: italic;
    }

    .markdown-content blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 1rem;
      font-style: italic;
      color: #4b5563;
      margin: 1rem 0;
    }

    .dark .markdown-content blockquote {
      color: #9ca3af;
    }

    .markdown-content code {
      background-color: #f3f4f6;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;
    }

    .dark .markdown-content code {
      background-color: #1f2937;
    }

    .markdown-content pre {
      background-color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin-bottom: 1rem;
    }

    .dark .markdown-content pre {
      background-color: #1f2937;
    }
  </style>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // Initialize Supabase
    const supabaseUrl = 'https://hilbbjnnxkitxbptektg.supabase.co'
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpbGJiam5ueGtpdHhicHRla3RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTYwNDIsImV4cCI6MjA2Mzc3MjA0Mn0.vk8AJ2pofRAy5y26WQeMYgEFudU1plXnYa6sMFyATFM'
    const supabase = createClient(supabaseUrl, supabaseAnonKey)

    // Get report ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search)
    const reportId = urlParams.get('id')

    if (!reportId) {
      showError('No report ID provided in URL')
    } else {
      // Load and display the report
      loadReport(reportId)
    }

    async function loadReport(id) {
      try {
        const { data, error } = await supabase
          .from('v_ai_reports')
          .select('*')
          .eq('id', id)
          .single()

        if (error) {
          throw new Error(error.message)
        }

        if (!data) {
          throw new Error('Report not found')
        }

        displayReport(data)
      } catch (err) {
        console.error('Error loading report:', err)
        showError(err.message)
      }
    }

    function displayReport(report) {
      document.getElementById('loading-state').classList.add('hidden')

      const content = `
        <!-- Header Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <div>
                  <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    ${report.organization_name} Breach Report
                  </h1>
                  <div class="flex items-center space-x-4 mt-1">
                    <span class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded text-sm">
                      ðŸ¤– AI Generated - Business Intelligence Focus
                    </span>
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                      ${new Date(report.completed_at || report.created_at).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              </div>
              <div class="flex items-center space-x-2">
                <button onclick="downloadReport()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm">
                  ðŸ“¥ Download
                </button>
                <button onclick="shareReport()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm">
                  ðŸ”— Share
                </button>
              </div>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${report.affected_individuals ? report.affected_individuals.toLocaleString() : 'Unknown'}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">People Affected</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400">${report.source_name || 'Unknown'}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Data Source</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${report.breach_date ? new Date(report.breach_date).toLocaleDateString() : 'Unknown'}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Breach Date</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">${report.processing_time_ms ? Math.round(report.processing_time_ms / 1000) + 's' : 'N/A'}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Analysis Time</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Report Content -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
          <div class="p-8">
            <div class="markdown-content">
              ${convertMarkdownToHTML(report.markdown_content || 'Report content is being processed...')}
            </div>
          </div>
        </div>
      `

      document.getElementById('report-content').innerHTML = content
      document.getElementById('report-content').classList.remove('hidden')

      // Store report data globally for download/share functions
      window.currentReport = report
    }

    function showError(message) {
      document.getElementById('loading-state').classList.add('hidden')
      document.getElementById('error-state').classList.remove('hidden')
      document.getElementById('error-message').textContent = message
    }

    // Global functions for download and share
    window.downloadReport = function() {
      if (!window.currentReport) return

      const blob = new Blob([window.currentReport.markdown_content], { type: 'text/markdown' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `${window.currentReport.organization_name}_breach_report.md`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(url)
    }

    window.shareReport = function() {
      if (navigator.share) {
        navigator.share({
          title: `${window.currentReport?.organization_name} Breach Report`,
          text: `AI-generated breach analysis for ${window.currentReport?.organization_name}`,
          url: window.location.href
        }).catch(console.log)
      } else {
        navigator.clipboard.writeText(window.location.href)
        alert('Report URL copied to clipboard')
      }
    }

    // Simple markdown to HTML converter
    function convertMarkdownToHTML(markdown) {
      return markdown
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/gim, '<em>$1</em>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
        .replace(/\n\n/gim, '</p><p>')
        .replace(/\n/gim, '<br>')
        .replace(/^(.*)$/gim, '<p>$1</p>')
    }
  </script>
</Layout>
