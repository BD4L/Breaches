---
// AI Report Page - Static page that handles dynamic report viewing client-side
// URL: /ai-report?id=report-id
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Breach Report | Security Intelligence Hub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Dark mode support -->
    <script>
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    
    <!-- Meta tags for sharing -->
    <meta property="og:title" content="AI Breach Report - Security Intelligence Hub" />
    <meta property="og:description" content="Comprehensive AI-generated analysis of data breach incidents" />
    <meta property="og:type" content="article" />
    
    <!-- Styles for markdown content -->
    <style>
      .markdown-content {
        @apply prose prose-gray dark:prose-invert max-w-none;
      }
      
      .markdown-content h1 {
        @apply text-3xl font-bold text-gray-900 dark:text-white mb-6 border-b border-gray-200 dark:border-gray-700 pb-4;
      }
      
      .markdown-content h2 {
        @apply text-2xl font-semibold text-gray-900 dark:text-white mt-8 mb-4;
      }
      
      .markdown-content h3 {
        @apply text-xl font-medium text-gray-900 dark:text-white mt-6 mb-3;
      }
      
      .markdown-content p {
        @apply text-gray-700 dark:text-gray-300 mb-4 leading-relaxed;
      }
      
      .markdown-content ul, .markdown-content ol {
        @apply text-gray-700 dark:text-gray-300 mb-4 ml-6;
      }
      
      .markdown-content li {
        @apply mb-2;
      }
      
      .markdown-content a {
        @apply text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 underline;
      }
      
      .markdown-content strong {
        @apply font-semibold text-gray-900 dark:text-white;
      }
      
      .markdown-content em {
        @apply italic;
      }
      
      .markdown-content blockquote {
        @apply border-l-4 border-blue-500 pl-4 italic text-gray-600 dark:text-gray-400 my-4;
      }
      
      .markdown-content code {
        @apply bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-sm font-mono;
      }
      
      .markdown-content pre {
        @apply bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto mb-4;
      }
      
      .markdown-content table {
        @apply w-full border-collapse border border-gray-300 dark:border-gray-600 mb-4;
      }
      
      .markdown-content th, .markdown-content td {
        @apply border border-gray-300 dark:border-gray-600 px-4 py-2 text-left;
      }
      
      .markdown-content th {
        @apply bg-gray-100 dark:bg-gray-800 font-semibold;
      }
    </style>
  </head>
  
  <body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Loading State -->
    <div id="loading-state" class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
          Loading AI Report
        </h2>
        <p class="text-gray-600 dark:text-gray-400">
          Retrieving your breach analysis...
        </p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="min-h-screen flex items-center justify-center hidden">
      <div class="text-center max-w-md">
        <div class="text-red-600 dark:text-red-400 mb-4">
          <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Report Not Found</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4" id="error-message">
          The requested report could not be found.
        </p>
        <button 
          onclick="window.history.back()" 
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
        >
          Go Back
        </button>
      </div>
    </div>

    <!-- Report Content -->
    <div id="report-content" class="hidden">
      <!-- This will be populated by JavaScript -->
    </div>

    <!-- Supabase and React Scripts -->
    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
      
      // Initialize Supabase
      const supabaseUrl = 'https://hilbbjnnxkitxbptektg.supabase.co'
      const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpbGJiam5ueGtpdHhicHRla3RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTYwNDIsImV4cCI6MjA2Mzc3MjA0Mn0.vk8AJ2pofRAy5y26WQeMYgEFudU1plXnYa6sMFyATFM'
      const supabase = createClient(supabaseUrl, supabaseAnonKey)

      // Get report ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search)
      const reportId = urlParams.get('id')

      if (!reportId) {
        showError('No report ID provided in URL')
        return
      }

      // Load and display the report
      loadReport(reportId)

      async function loadReport(id) {
        try {
          const { data, error } = await supabase
            .from('v_ai_reports')
            .select('*')
            .eq('id', id)
            .single()

          if (error) {
            throw new Error(error.message)
          }

          if (!data) {
            throw new Error('Report not found')
          }

          displayReport(data)
        } catch (err) {
          console.error('Error loading report:', err)
          showError(err.message)
        }
      }

      function displayReport(report) {
        document.getElementById('loading-state').classList.add('hidden')
        
        const content = `
          <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                  </button>
                  <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                      ${report.organization_name} Breach Report
                    </h1>
                    <div class="flex items-center space-x-4 mt-1">
                      <span class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-1 rounded text-sm">
                        ðŸ¤– AI Generated
                      </span>
                      <span class="text-sm text-gray-500 dark:text-gray-400">
                        ${new Date(report.completed_at || report.created_at).toLocaleDateString()}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <button onclick="downloadReport()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm">
                    ðŸ“¥ Download
                  </button>
                  <button onclick="shareReport()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded text-sm">
                    ðŸ”— Share
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-8">
              <div class="markdown-content">
                ${convertMarkdownToHTML(report.markdown_content || 'Report content is being processed...')}
              </div>
            </div>
          </div>
        `
        
        document.getElementById('report-content').innerHTML = content
        document.getElementById('report-content').classList.remove('hidden')

        // Store report data globally for download/share functions
        window.currentReport = report
      }

      function showError(message) {
        document.getElementById('loading-state').classList.add('hidden')
        document.getElementById('error-state').classList.remove('hidden')
        document.getElementById('error-message').textContent = message
      }

      // Global functions for download and share
      window.downloadReport = function() {
        if (!window.currentReport) return
        
        const blob = new Blob([window.currentReport.markdown_content], { type: 'text/markdown' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `${window.currentReport.organization_name}_breach_report.md`
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      }

      window.shareReport = function() {
        if (navigator.share) {
          navigator.share({
            title: `${window.currentReport?.organization_name} Breach Report`,
            text: `AI-generated breach analysis for ${window.currentReport?.organization_name}`,
            url: window.location.href
          }).catch(console.log)
        } else {
          navigator.clipboard.writeText(window.location.href)
          alert('Report URL copied to clipboard')
        }
      }

      // Simple markdown to HTML converter
      function convertMarkdownToHTML(markdown) {
        return markdown
          .replace(/^# (.*$)/gim, '<h1>$1</h1>')
          .replace(/^## (.*$)/gim, '<h2>$1</h2>')
          .replace(/^### (.*$)/gim, '<h3>$1</h3>')
          .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/gim, '<em>$1</em>')
          .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
          .replace(/\n\n/gim, '</p><p>')
          .replace(/\n/gim, '<br>')
          .replace(/^(.*)$/gim, '<p>$1</p>')
      }
    </script>
  </body>
</html>
