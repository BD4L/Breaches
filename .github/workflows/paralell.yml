name: Run All Scrapers (Parallel)

on:
  schedule:
    - cron: '*/30 * * * *' # Runs every 30 minutes
  workflow_dispatch: # Allows manual triggering
    inputs:
      run_government:
        description: 'Run Government & Federal Scrapers'
        required: false
        default: true
        type: boolean
      run_state_ag_1:
        description: 'Run State AG Group 1 (DE, CA, WA, HI)'
        required: false
        default: true
        type: boolean
      run_state_ag_2:
        description: 'Run State AG Group 2 (IN, IA, ME)'
        required: false
        default: true
        type: boolean
      run_state_ag_3:
        description: 'Run State AG Group 3 (MA, MT, NH, NJ)'
        required: false
        default: true
        type: boolean
      run_state_ag_4:
        description: 'Run State AG Group 4 (ND, OK, VT, WI, TX)'
        required: false
        default: true
        type: boolean
      run_problematic:
        description: 'Run Problematic Scrapers (MD)'
        required: false
        default: true
        type: boolean
      scraping_frequency:
        description: 'Set scraping frequency (for future scheduling)'
        required: false
        default: 'daily'
        type: choice
        options:
          - 'daily'
          - 'every-6-hours'
          - 'every-12-hours'
          - 'twice-daily'

jobs:
  # ============================================================================
  # PRE-SCRAPING SNAPSHOT - Capture database state before scraping
  # ============================================================================

  pre-scraping-snapshot:
    name: "üì∏ Pre-Scraping Database Snapshot"
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Take database snapshot
        run: |
          export SNAPSHOT_FILE=/tmp/parallel_scraper_snapshot.json
          python scrapers/database_change_tracker.py --snapshot
      - name: Upload snapshot
        uses: actions/upload-artifact@v4
        with:
          name: parallel-database-snapshot
          path: /tmp/parallel_scraper_snapshot.json
          retention-days: 1

  # ============================================================================
  # PARALLEL SCRAPER GROUPS - Run simultaneously for faster execution
  # ============================================================================

  government-scrapers:
    name: "Government & Federal Scrapers"
    runs-on: ubuntu-latest
    needs: pre-scraping-snapshot
    if: ${{ github.event.inputs.run_government != 'false' }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      HIBP_API_KEY: ${{ secrets.HIBP_API_KEY }}
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run SEC EDGAR 8-K Scraper
        run: python scrapers/fetch_sec_edgar_8k.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run HHS OCR Scraper
        run: python scrapers/fetch_hhs_ocr.py

  state-ag-group-1:
    name: "State AG Group 1 (DE, WA, HI)"
    runs-on: ubuntu-latest
    needs: pre-scraping-snapshot
    if: ${{ github.event.inputs.run_state_ag_1 != 'false' }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      PYTHONUNBUFFERED: "1"
      # Washington AG configuration
      WA_AG_FILTER_FROM_DATE: "2025-06-01"
      # Hawaii AG configuration
      HI_AG_FILTER_FROM_DATE: "2025-06-01"
      HI_AG_PROCESSING_MODE: "FULL"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Delaware AG Scraper
        run: python scrapers/fetch_delaware_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Washington AG Scraper
        run: python scrapers/fetch_washington_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Hawaii AG Scraper
        run: python scrapers/fetch_hi_ag.py

  state-ag-group-2:
    name: "State AG Group 2 (IN, IA, ME)"
    runs-on: ubuntu-latest
    needs: pre-scraping-snapshot
    if: ${{ github.event.inputs.run_state_ag_2 != 'false' }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      PYTHONUNBUFFERED: "1"
      # Indiana AG configuration
      IN_AG_FILTER_FROM_DATE: "2025-06-01"
      IN_AG_PROCESSING_MODE: "ENHANCED"
      # Iowa AG configuration
      IA_AG_FILTER_FROM_DATE: "2025-06-01"
      IA_AG_PROCESSING_MODE: "ENHANCED"
      # Maine AG configuration
      ME_AG_FILTER_FROM_DATE: "2025-06-01"
      ME_AG_PROCESSING_MODE: "ENHANCED"
      ME_AG_MAX_PAGES: "2"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Indiana AG Scraper
        run: python scrapers/fetch_in_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Iowa AG Scraper
        run: python scrapers/fetch_ia_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Maine AG Scraper
        run: python scrapers/fetch_me_ag.py

  state-ag-group-3:
    name: "State AG Group 3 (MA, MT, NH, NJ)"
    runs-on: ubuntu-latest
    needs: pre-scraping-snapshot
    if: ${{ github.event.inputs.run_state_ag_3 != 'false' }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      PYTHONUNBUFFERED: "1"
      # Massachusetts AG configuration
      MA_AG_FILTER_DAYS_BACK: "19"
      MA_AG_PROCESSING_MODE: "ENHANCED"
      MA_AG_FORCE_PROCESS: "true"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Massachusetts AG Scraper
        run: python scrapers/fetch_ma_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Montana AG Scraper
        run: python scrapers/fetch_mt_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run New Hampshire AG Scraper
        run: python scrapers/fetch_nh_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run New Jersey Cybersecurity Scraper
        run: python scrapers/fetch_nj_ag.py

  state-ag-group-4:
    name: "State AG Group 4 (ND, OK, VT, WI, TX)"
    runs-on: ubuntu-latest
    needs: pre-scraping-snapshot
    if: ${{ github.event.inputs.run_state_ag_4 != 'false' }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      PYTHONUNBUFFERED: "1"
      # Texas AG configuration
      TX_AG_FILTER_FROM_DATE: "2025-06-01"
      TX_AG_PROCESSING_MODE: "ENHANCED"
      # Vermont AG configuration
      VT_AG_FILTER_FROM_DATE: "2025-06-01"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Install Playwright browsers
        run: playwright install chromium
      - name: Install Chrome for Selenium
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      - name: Run North Dakota AG Scraper
        run: python scrapers/fetch_nd_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Oklahoma Cybersecurity Scraper
        run: python scrapers/fetch_ok_cyber.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Vermont AG Scraper
        run: python scrapers/fetch_vt_ag.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Wisconsin DATCP Scraper
        run: python scrapers/fetch_wi_datcp.py
      - name: Wait between scrapers
        run: sleep 10
      - name: Run Texas AG Scraper
        run: python scrapers/fetch_texas_ag.py

  # ============================================================================
  # NOTE: RSS & API scrapers have been moved to a separate workflow
  # See: .github/workflows/rss-api-scrapers.yml
  # This separation prevents RSS/API failures from affecting state portal scrapers
  # ============================================================================

  # ============================================================================
  # PROBLEMATIC SCRAPERS - Sites with known issues (run separately for monitoring)
  # ============================================================================

  problematic-scrapers:
    name: "Problematic Scrapers (MD)"
    runs-on: ubuntu-latest
    needs: pre-scraping-snapshot
    if: ${{ github.event.inputs.run_problematic != 'false' }}
    continue-on-error: true # Don't fail the workflow if these scrapers fail
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run Maryland AG Scraper (Known Issues)
        run: |
          echo "‚ö†Ô∏è Running Maryland AG scraper - known to have website issues"
          python scrapers/fetch_md_ag.py || echo "‚ùå Maryland AG scraper failed as expected"

  # ============================================================================
  # SUMMARY JOB - Waits for all parallel jobs to complete
  # ============================================================================

  summary:
    name: "üìä Scraping Summary & Database Changes"
    runs-on: ubuntu-latest
    needs: [pre-scraping-snapshot, government-scrapers, state-ag-group-1, state-ag-group-2, state-ag-group-3, state-ag-group-4, problematic-scrapers]
    if: always() # Run even if some jobs fail
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      PYTHONUNBUFFERED: "1"
    outputs:
      new_items: ${{ steps.database-report.outputs.new_items }}
      new_breaches: ${{ steps.database-report.outputs.new_breaches }}
      new_news: ${{ steps.database-report.outputs.new_news }}
      new_affected: ${{ steps.database-report.outputs.new_affected }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Download snapshot
        uses: actions/download-artifact@v4
        with:
          name: parallel-database-snapshot
          path: /tmp/
      - name: Debug snapshot file
        run: |
          echo "üîç DEBUG: Checking snapshot file..."
          ls -la /tmp/parallel_scraper_snapshot.json || echo "‚ùå Snapshot file not found"
          if [ -f /tmp/parallel_scraper_snapshot.json ]; then
            echo "üìÑ Snapshot file size: $(wc -c < /tmp/parallel_scraper_snapshot.json) bytes"
            echo "üìä Snapshot preview (first 500 chars):"
            head -c 500 /tmp/parallel_scraper_snapshot.json
            echo ""
          fi
      - name: Generate database change report
        id: database-report
        run: |
          echo "üìä Generating database change report..."
          export SNAPSHOT_FILE=/tmp/parallel_scraper_snapshot.json
          python scrapers/database_change_tracker.py --report || {
            echo "‚ö†Ô∏è  Database report failed, setting default outputs"
            echo "new_items=0" >> $GITHUB_OUTPUT
            echo "new_breaches=0" >> $GITHUB_OUTPUT
            echo "new_news=0" >> $GITHUB_OUTPUT
            echo "new_affected=0" >> $GITHUB_OUTPUT
          }
      - name: Show today's daily activity context
        run: |
          echo ""
          echo "üìÖ TODAY'S DAILY CONTEXT (1am to now):"
          python scrapers/daily_change_tracker.py --today
      - name: Check job results
        run: |
          set +e  # Disable exit on error for this section
          echo "=== PARALLEL SCRAPING SUMMARY ==="
          echo "Government & Federal: ${{ needs.government-scrapers.result }}"
          echo "State AG Group 1 (DE,WA,HI): ${{ needs.state-ag-group-1.result }}"
          echo "State AG Group 2 (IN,IA,ME): ${{ needs.state-ag-group-2.result }}"
          echo "State AG Group 3 (MA,MT,NH,NJ): ${{ needs.state-ag-group-3.result }}"
          echo "State AG Group 4 (ND,OK,VT,WI,TX): ${{ needs.state-ag-group-4.result }}"
          echo "Problematic Scrapers (MD): ${{ needs.problematic-scrapers.result }}"
          echo "================================="
          echo "‚ÑπÔ∏è  Note: California AG runs hourly in separate workflow"
          echo "‚ÑπÔ∏è  Note: RSS & API scrapers run in separate workflow"

          # Count successful jobs (excluding problematic scrapers from main count)
          success_count=0
          total_count=5

          # Use safer arithmetic that won't fail
          [[ "${{ needs.government-scrapers.result }}" == "success" ]] && success_count=$((success_count + 1))
          [[ "${{ needs.state-ag-group-1.result }}" == "success" ]] && success_count=$((success_count + 1))
          [[ "${{ needs.state-ag-group-2.result }}" == "success" ]] && success_count=$((success_count + 1))
          [[ "${{ needs.state-ag-group-3.result }}" == "success" ]] && success_count=$((success_count + 1))
          [[ "${{ needs.state-ag-group-4.result }}" == "success" ]] && success_count=$((success_count + 1))

          echo "‚úÖ Successful core groups: $success_count/$total_count"

          # Report on problematic scrapers separately
          if [[ "${{ needs.problematic-scrapers.result }}" == "success" ]]; then
            echo "üîß Problematic scrapers: Unexpectedly succeeded!"
          else
            echo "‚ö†Ô∏è Problematic scrapers: Failed as expected (Maryland AG has known website issues)"
          fi

          # Determine overall success - only fail if NO core groups succeeded
          if [ $success_count -eq $total_count ]; then
            echo "üéâ All core scraper groups completed successfully!"
            WORKFLOW_SUCCESS=true
          elif [ $success_count -gt 0 ]; then
            echo "‚ö†Ô∏è Some core scraper groups failed, but $success_count groups succeeded"
            WORKFLOW_SUCCESS=true
          else
            echo "‚ùå All core scraper groups failed"
            WORKFLOW_SUCCESS=false
          fi

          echo ""
          echo "üìä DATABASE CHANGES SUMMARY:"
          echo "   Items Change: ${{ steps.database-report.outputs.new_items }}"
          echo "   Breaches Change: ${{ steps.database-report.outputs.new_breaches }}"
          echo "   News Change: ${{ steps.database-report.outputs.new_news }}"
          echo "   People Affected Change: ${{ steps.database-report.outputs.new_affected }}"

          # Interpret the results with enhanced error handling
          NEW_ITEMS="${{ steps.database-report.outputs.new_items }}"
          NEW_BREACHES="${{ steps.database-report.outputs.new_breaches }}"
          NEW_NEWS="${{ steps.database-report.outputs.new_news }}"
          NEW_AFFECTED="${{ steps.database-report.outputs.new_affected }}"

          # Handle empty/null values by defaulting to 0 and ensure they're numeric
          NEW_ITEMS=${NEW_ITEMS:-0}
          NEW_BREACHES=${NEW_BREACHES:-0}
          NEW_NEWS=${NEW_NEWS:-0}
          NEW_AFFECTED=${NEW_AFFECTED:-0}

          # Debug: Show raw values received
          echo "üîç DEBUG: Raw values from database report:"
          echo "   NEW_ITEMS='${{ steps.database-report.outputs.new_items }}'"
          echo "   NEW_BREACHES='${{ steps.database-report.outputs.new_breaches }}'"
          echo "   NEW_NEWS='${{ steps.database-report.outputs.new_news }}'"
          echo "   NEW_AFFECTED='${{ steps.database-report.outputs.new_affected }}'"

          # Validate that values are numeric and fix if needed
          if ! [[ "$NEW_ITEMS" =~ ^-?[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Warning: NEW_ITEMS '$NEW_ITEMS' is not numeric, defaulting to 0"
            NEW_ITEMS=0
          fi

          if ! [[ "$NEW_BREACHES" =~ ^-?[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Warning: NEW_BREACHES '$NEW_BREACHES' is not numeric, defaulting to 0"
            NEW_BREACHES=0
          fi

          if ! [[ "$NEW_NEWS" =~ ^-?[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Warning: NEW_NEWS '$NEW_NEWS' is not numeric, defaulting to 0"
            NEW_NEWS=0
          fi

          if ! [[ "$NEW_AFFECTED" =~ ^-?[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Warning: NEW_AFFECTED '$NEW_AFFECTED' is not numeric, defaulting to 0"
            NEW_AFFECTED=0
          fi

          echo "‚úÖ Validated values: items=$NEW_ITEMS, breaches=$NEW_BREACHES, news=$NEW_NEWS, affected=$NEW_AFFECTED"

          if [ "$NEW_ITEMS" -lt 0 ]; then
            echo "‚ÑπÔ∏è  Note: Negative values indicate database cleanup (duplicate removal)"
          elif [ "$NEW_ITEMS" -eq 0 ]; then
            echo "‚ÑπÔ∏è  No new items discovered in this run"
          else
            echo "‚úÖ $NEW_ITEMS new items discovered!"
          fi

          # Final workflow status
          if [ "$WORKFLOW_SUCCESS" = "true" ]; then
            echo "üéâ Workflow completed successfully!"
            exit 0
          else
            echo "‚ùå Workflow failed - no core scraper groups succeeded"
            exit 1
          fi

  # ============================================================================
  # EMAIL ALERTS JOB - Send email notifications to subscribers
  # ============================================================================

  email-alerts:
    name: "üìß Email Alert Notifications"
    runs-on: ubuntu-latest
    needs: summary
    if: ${{ always() && needs.summary.outputs.new_breaches > 0 && needs.summary.outputs.new_breaches != '' && needs.summary.outputs.new_breaches != 'null' }}
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      ALERT_FROM_EMAIL: ${{ secrets.ALERT_FROM_EMAIL }}
      DASHBOARD_URL: "https://bd4l.github.io/Breaches/"
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install requests  # Add requests for Resend API
      - name: Send email alerts
        run: |
          echo "üìß Processing email alerts for new breaches..."
          python scrapers/email_alerts.py --since-minutes 35
          echo ""
          echo "‚úÖ Email alert processing complete"
      - name: Log alert summary
        run: |
          echo "üö® BREACH ALERT SUMMARY:"
          echo "üìä New breaches detected: ${{ needs.summary.outputs.new_breaches }}"
          echo "üìä Total new items: ${{ needs.summary.outputs.new_items }}"
          echo "üë• Additional people affected: ${{ needs.summary.outputs.new_affected }}"
          echo ""
          echo "üîó View dashboard: https://bd4l.github.io/Breaches/"
          echo "üìß Email alerts have been sent to subscribers"

  # ============================================================================
  # NOTIFICATION JOB - Send alerts if significant changes detected (Legacy)
  # ============================================================================

  notification:
    name: "üîî Breach Alert Notification (Legacy)"
    runs-on: ubuntu-latest
    needs: summary
    if: ${{ always() && needs.summary.outputs.new_breaches > 0 && needs.summary.outputs.new_breaches != '' && needs.summary.outputs.new_breaches != 'null' }}
    steps:
      - name: Send breach alert
        run: |
          echo "üö® BREACH ALERT: ${{ needs.summary.outputs.new_breaches }} new breach notifications detected!"
          echo "üìä Total new items: ${{ needs.summary.outputs.new_items }}"
          echo "üë• Additional people affected: ${{ needs.summary.outputs.new_affected }}"
          echo ""
          echo "üîó View dashboard: https://hackermanmarlin.github.io/Breaches/"
          echo ""
          echo "üìß Email alerts are now handled by the email-alerts job above."


